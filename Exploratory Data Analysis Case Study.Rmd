---
title: "Exploratory Data Analysis Case Study"
author: "Hanxi Gu"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}

# package loading 
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gridExtra)
library(skimr)
library(grid)
library(scales)
library(mice)
library(naniar)

# adjust size of figure
knitr::opts_chunk$set(fig.width=10)

# reading file
BlackFriday = read_csv("BlackFriday_data.csv", show_col_types = FALSE)
```

##  Utility functions

```{r}

# define function to display Missing value, Unique values, Mean, Min, Max and SD
summarize_numeric = function(dataset) {
  
  dataset = select_if(dataset, is.numeric)
  summary.table = data.frame(Attribute = names(dataset))
  
  summary.table = summary.table %>% 
    mutate('Missing Values' = apply(dataset, 2, function (x) sum(is.na(x))),
           'Unique Values' = apply(dataset, 2, function (x) length(unique(x))),
           'Mean' = colMeans(dataset, na.rm = TRUE),
           'Min' = apply(dataset, 2, function (x) min(x, na.rm = TRUE)),
           'Max' = apply(dataset, 2, function (x) max(x, na.rm = TRUE)),
           'SD' = apply(dataset, 2, function (x) sd(x, na.rm = TRUE))
    )
  summary.table
}

# for character columns, calculate missing values and unique values
summarize_character = function(dataset) {
  
  dataset = select_if(dataset, is.character)
  summary.table = data.frame(Attribute = names(dataset))
  
  summary.table = summary.table %>% 
    mutate('Missing Values' = apply(dataset, 2, function (x) sum(is.na(x))),
           'Unique Values' = apply(dataset, 2, function (x) length(unique(x))),
    )
  summary.table
}
```

```{r}
summarize_character(BlackFriday)
```

```{r}
summarize_numeric(BlackFriday)
```

### Missing Value Treatment

```{r}

# Calculate the percentage of missing variabels
missing_values <- sapply(BlackFriday, function(x) sum(is.na(x)))
missing_values_percentage <- sapply(BlackFriday, function(x) mean(is.na(x)) * 100)

# Create a dataframe to save the data
missing_values_info <- data.frame(
  Variable = names(missing_values),
  MissingValues = missing_values,
  Percentage = missing_values_percentage
)

# Filter Missing Values
missing_values_info <- missing_values_info[missing_values_info$MissingValues > 0,]

# Visulization of Missing Values in Each Column
ggplot(missing_values_info, aes(x = Variable, y = Percentage)) +
  geom_bar(stat = "identity", fill = "gray") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Percentage of Missing Values in Each Column",
       x = "Columns",
       y = "Percentage (%)")

```

MCAR test was performed to validate the randomness of variables.

```{r}
result <- mcar_test(BlackFriday)
print(result)
```
```{r}
data_clean <- na.omit(BlackFriday$Purchase)

# Create a histogram with a density plot
ggplot(data.frame(Purchase=data_clean), aes(x=Purchase)) + 
    geom_histogram(aes(y=..density..), bins=30, fill="blue", alpha=0.7) +
    geom_density(colour="red", alpha=0.7) +
    theme_minimal() +
    labs(title="Distribution of Purchase", x="Purchase Amount", y="Density")
```

The category variables - Mode 
The continuous variable Purchase - Median due to the left-skewed distribution
User_id and Product_ID - dropped

```{r}

get_mode <- function(v) {
  uniqv <- unique(na.omit(v))
  uniqv[which.max(tabulate(match(v, uniqv)))]
}

# Impute categorical variables with mode
categorical_columns <- c("Gender", "Age", "Occupation", "City_Category", 
                         "Stay_In_Current_City_Years", "Marital_Status", 
                         "Product_Category_1", "Product_Category_2", "Product_Category_3")
for (col in categorical_columns) {
  mode_value <- get_mode(BlackFriday[[col]])
  BlackFriday[[col]][is.na(BlackFriday[[col]])] <- mode_value
}


# Impute 'Purchase' with median
BlackFriday_cleaned <- BlackFriday
median_purchase <- median(BlackFriday_cleaned$Purchase, na.rm = TRUE)
BlackFriday$Purchase[is.na(BlackFriday_cleaned$Purchase)] <- median_purchase

# Drop rows with missing 'User_ID' or 'Product_ID'
BlackFriday_cleaned <- BlackFriday_cleaned[!is.na(BlackFriday_cleaned$User_ID) & !is.na(BlackFriday_cleaned$Product_ID), ]

```

```{r}

boxplot(BlackFriday_cleaned$Purchase,width = 0.2,main="Boxplot of Purchase",na.rm = "True")

Q1 <- quantile(BlackFriday_cleaned$Purchase, 0.25,na.rm = "True")
Q3 <- quantile(BlackFriday_cleaned$Purchase, 0.75,na.rm = "True")
IQR <- Q3 - Q1
lower_bound <- Q1 - 1.5 * IQR
upper_bound <- Q3 + 1.5 * IQR
outliers <- BlackFriday_cleaned$Purchase[BlackFriday_cleaned$Purchase < lower_bound | BlackFriday_cleaned$Purchase > upper_bound]

```

```{r}
z_scores <- scale(BlackFriday$Purchase)
z_scores[z_scores > 3]
```

##  Initial Data Review

### Convert Factors/Measures

```{r}
BlackFriday_cleaned <- BlackFriday_cleaned %>% mutate(User_ID = as.factor(User_ID))
BlackFriday_cleaned <- BlackFriday_cleaned %>% mutate(Occupation = as.factor(Occupation))
BlackFriday_cleaned <- BlackFriday_cleaned %>% mutate(Stay_In_Current_City_Years = as.factor(Stay_In_Current_City_Years))
BlackFriday_cleaned <- BlackFriday_cleaned %>% mutate(Marital_Status = as.factor(Marital_Status))
BlackFriday_cleaned <- BlackFriday_cleaned %>% mutate(Product_Category_1 = as.factor(Product_Category_1))
BlackFriday_cleaned <- BlackFriday_cleaned %>% mutate(Product_Category_2 = as.factor(Product_Category_2))
BlackFriday_cleaned <- BlackFriday_cleaned %>% mutate(Product_Category_3 = as.factor(Product_Category_3))
BlackFriday_cleaned <- BlackFriday_cleaned %>% mutate(Product_ID = as.factor(Product_ID))
BlackFriday_cleaned <- BlackFriday_cleaned %>% mutate(Gender = as.factor(Gender))
BlackFriday_cleaned <- BlackFriday_cleaned %>% mutate(Age = as.factor(Age))
BlackFriday_cleaned <- BlackFriday_cleaned %>% mutate(City_Category = as.factor(City_Category))
```

```{r}
summarize_factor = function(dataset) {
  
  dataset = select_if(dataset, is.factor)
  summary.table = data.frame(Attribute = names(dataset))
  
  summary.table = summary.table %>% 
    mutate('Missing Values' = apply(dataset, 2, function (x) sum(is.na(x))),
           'Unique Values' = apply(dataset, 2, function (x) length(unique(x))),
           'Mode' = apply(dataset, 2, function(x)mode(x))
    )
  summary.table
}
summarize_factor(BlackFriday)
```

```{r}

User_data <- BlackFriday_cleaned %>%
  select(User_ID, Gender, Age, Occupation, City_Category, Stay_In_Current_City_Years, Marital_Status, Purchase)
cleaned_User_data <- User_data %>%
  group_by(User_ID) %>%
  summarize(
    Gender = first(Gender),
    Age = first(Age),
    Occupation = first(Occupation),
    City_Category = first(City_Category),
    Stay_In_Current_City_Years = first(Stay_In_Current_City_Years),
    Marital_Status = first(Marital_Status),
    Total_Purchase = sum(Purchase),
    Avg_Purchase = mean(Purchase),
    Max_Purchase = max(Purchase),
    Min_Purchase = min(Purchase),
    Num_Purchases = n()  # Number of purchases made by each customer
  )

Product_data <- BlackFriday_cleaned %>%
  select(Product_ID, Product_Category_1, Product_Category_2, Product_Category_3, Purchase)
cleaned_Product_data <- Product_data %>%
  group_by(Product_ID) %>%
  summarize(
    Product_Category_1 = first(Product_Category_1),
    Product_Category_2 = first(Product_Category_2),
    Product_Category_3 = first(Product_Category_3),
    Total_Purchase = sum(Purchase),
    Num_Purchases = n()  # Number of purchases made by each customer
  )

write.csv(cleaned_Product_data, file = "cleaned_Product1.csv", row.names = FALSE)
write.csv(cleaned_User_data, file = "cleaned_User1.csv", row.names = FALSE)

```

```{r}
options(scipen = 999)
summarize_character(cleaned_User_data)
summarize_numeric(cleaned_User_data)
```
```{r}
BlackFriday
BlackFriday_cleaned
```
```{r}
options(scipen = 999)
summarize_character(cleaned_Product_data)
summarize_numeric(cleaned_Product_data)
```

```{r}
ggplot(cleaned_User_data) + 
  geom_histogram(aes(x = Total_Purchase), fill = "#e8615b") +
  ggtitle("Purchase Amount") +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 25),  
    axis.title.x = element_blank(),
    axis.text = element_text(size = 20),  
    axis.title = element_text(size = 20)   
  )+
  scale_x_continuous(labels = comma)
```

```{r}
ggplot(cleaned_User_data) + 
  geom_histogram(aes(x = Num_Purchases), fill = "#e8615b") +
  ggtitle("Number of Purchase") +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 25),  
    axis.title.x = element_blank(),
    axis.text = element_text(size = 20),  
    axis.title = element_text(size = 20)   
  )+
  scale_x_continuous(labels = comma)
```

```{r}
ggplot(cleaned_User_data) + 
  geom_bar(aes(x = Gender), fill = "#e8615b") +
  ggtitle("Gender") +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 25),
    axis.title.x = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 20)
  ) +
  scale_y_continuous(labels = comma)
```

```{r}
ggplot(cleaned_User_data) + geom_bar(aes(x = Age), fill = "#e8615b") +
  ggtitle("Age") +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 25),  
    axis.title.x = element_blank(),
    axis.text = element_text(size = 20),  
    axis.title = element_text(size = 20)   
  )
```

```{r}
ggplot(cleaned_User_data) + geom_bar(aes(x = Occupation), fill = "#e8615b") +
  ggtitle("Occupation") +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 25),  
    axis.title.x = element_blank(),
    axis.text = element_text(size = 20),  
    axis.title = element_text(size = 20)   
  )
```

```{r}
ggplot(cleaned_User_data) + geom_bar(aes(x = City_Category), fill = "#e8615b") +
  ggtitle("City_Category") +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 25),  
    axis.title.x = element_blank(),
    axis.text = element_text(size = 20),  
    axis.title = element_text(size = 20)   
  )
```

```{r}
ggplot(cleaned_User_data) + geom_bar(aes(x = Stay_In_Current_City_Years), fill = "#e8615b") +
  ggtitle("Stay_In_Current_City_Years") +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 25),  
    axis.title.x = element_blank(),
    axis.text = element_text(size = 20),  
    axis.title = element_text(size = 20)   
  )
```

```{r}
ggplot(cleaned_User_data) + 
  geom_bar(aes(x = Marital_Status), fill = "#e8615b") +
  ggtitle("Marital Status") +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 25),
    axis.title.x = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 20)
  ) +
  scale_x_discrete(labels = c("0" = "No", "1" = "Yes"))
```

```{r}
ggplot(cleaned_Product_data) + 
  geom_histogram(aes(x = Total_Purchase), fill = "#efac37") +
  ggtitle("Purchase Amount") +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 25),  
    axis.title.x = element_blank(),
    axis.text = element_text(size = 20),  
    axis.title = element_text(size = 20)   
  )+
  scale_x_continuous(labels = comma)
```

```{r}
ggplot(cleaned_Product_data) + 
  geom_histogram(aes(x = Num_Purchases), fill = "#efac37") +
  ggtitle("Number of Purchase") +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 25),  
    axis.title.x = element_blank(),
    axis.text = element_text(size = 20),  
    axis.title = element_text(size = 20)   
  )+
  scale_x_continuous(labels = comma)
```





```{r}
ggplot(cleaned_Product_data) + 
  geom_bar(aes(x = Product_Category_1), fill = "#efac37") +
  ggtitle("Product Category 1") +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 25),
    axis.title.x = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 20)
  ) 
```

```{r}
ggplot(cleaned_Product_data) + 
  geom_bar(aes(x = Product_Category_2), fill = "#efac37") +
  ggtitle("Product Category 2") +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 25),
    axis.title.x = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 20)
  ) 
```

```{r}
ggplot(cleaned_Product_data) + 
  geom_bar(aes(x = Product_Category_3), fill = "#efac37") +
  ggtitle("Product Category 3") +
  theme_minimal() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 25),
    axis.title.x = element_blank(),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 20)
  )  +
  scale_y_continuous(labels = comma)
```

```{r}
ggplot(cleaned_User_data, aes(x = Gender, y = Total_Purchase, fill = Gender)) + 
  geom_boxplot() +
  labs(y = "Purchase", x = "Gender") +
  theme_minimal() +
  scale_fill_manual(values = c("M" = "#efac37", "F" = "#e8615b")) +
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  )+
  scale_y_continuous(labels = comma)
```

```{r}
ggplot(cleaned_User_data, aes(x = Age, y = Total_Purchase, fill = Age)) + 
  geom_boxplot() +
  labs(y = "Purchase", x = "Age") +
  theme_minimal() +
  scale_fill_manual(values = c("0-17" = "#2f4a7f", "18-25" = "#efac37", "26-35" = "#162e4c", "36-45" = "#e8615b", "46-50" = "#476b9e", "51-55" = "#e5931c", "55+" = "#5982b2")) +
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  )+
  scale_y_continuous(labels = comma)
```

```{r}
ggplot(cleaned_User_data, aes(x = City_Category, y = Total_Purchase, fill = City_Category)) + 
  geom_boxplot() +
  labs(y = "Purchase", x = "City Category") +
  theme_minimal() +
  scale_fill_manual(values = c("A" = "#efac37", "B" = "#e8615b", "C" = "#2f4a7f")) +
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  )+
  scale_y_continuous(labels = comma)
```

```{r}
cleaned_User_data$Stay_In_Current_City_Years <- factor(cleaned_User_data$Stay_In_Current_City_Years)

ggplot(cleaned_User_data, aes(x = Stay_In_Current_City_Years, y = Total_Purchase, fill = Stay_In_Current_City_Years)) + 
  geom_boxplot() +
  labs(y = "Total Purchase", x = "Stay In Current City Years") +
  theme_minimal() +
  scale_fill_manual(values = c("#2f4a7f", "#efac37", "#5982b2", "#e8615b", "#476b9e")) +
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  ) +
  scale_y_continuous(labels = comma)
```

```{r}
cleaned_User_data$Marital_Status <- factor(cleaned_User_data$Marital_Status)

ggplot(cleaned_User_data, aes(x = Marital_Status, y = Total_Purchase, fill = Marital_Status)) + 
  geom_boxplot() +
  labs(y = "Purchase", x = "Marital Status") +
  theme_minimal() +
  scale_x_discrete(labels = c("0" = "No", "1" = "Yes"))+
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  )+
  scale_fill_manual(values = c("0" = "#efac37", "1" = "#e8615b")) +
  scale_y_continuous(labels = comma)
```

```{r}
ggplot(cleaned_User_data, aes(x = Gender, y = Num_Purchases, fill = Gender)) + 
  geom_boxplot() +
  labs(y = "Number of Purchases", x = "Gender") +
  theme_minimal() +
  scale_fill_manual(values = c("M" = "#efac37", "F" = "#e8615b")) +
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  )+
  scale_y_continuous(labels = comma)
```

```{r}
ggplot(cleaned_User_data, aes(x = Age, y = Num_Purchases, fill = Age)) + 
  geom_boxplot() +
  labs(y = "Purchase", x = "Age") +
  theme_minimal() +
  scale_fill_manual(values = c("0-17" = "#2f4a7f", "18-25" = "#efac37", "26-35" = "#162e4c", "36-45" = "#e8615b", "46-50" = "#476b9e", "51-55" = "#e5931c", "55+" = "#5982b2")) +
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  )+
  scale_y_continuous(labels = comma)
```

```{r}
ggplot(cleaned_User_data, aes(x = City_Category, y = Num_Purchases, fill = City_Category)) + 
  geom_boxplot() +
  labs(y = "Purchase", x = "City Category") +
  theme_minimal() +
  scale_fill_manual(values = c("A" = "#efac37", "B" = "#e8615b", "C" = "#2f4a7f")) +
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  )+
  scale_y_continuous(labels = comma)
```

```{r}
cleaned_User_data$Stay_In_Current_City_Years <- factor(cleaned_User_data$Stay_In_Current_City_Years)

ggplot(cleaned_User_data, aes(x = Stay_In_Current_City_Years, y = Num_Purchases, fill = Stay_In_Current_City_Years)) + 
  geom_boxplot() +
  labs(y = "Total Purchase", x = "Stay In Current City Years") +
  theme_minimal() +
  scale_fill_manual(values = c("#2f4a7f", "#efac37", "#5982b2", "#e8615b", "#476b9e")) +
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  ) +
  scale_y_continuous(labels = comma)
```

```{r}
cleaned_User_data$Marital_Status <- factor(cleaned_User_data$Marital_Status)

ggplot(cleaned_User_data, aes(x = Marital_Status, y = Num_Purchases, fill = Marital_Status)) + 
  geom_boxplot() +
  labs(y = "Purchase", x = "Marital Status") +
  theme_minimal() +
  scale_x_discrete(labels = c("0" = "No", "1" = "Yes"))+
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  )+
  scale_fill_manual(values = c("0" = "#efac37", "1" = "#e8615b")) +
  scale_y_continuous(labels = comma)
```

```{r}
gender_purchase_totals <- cleaned_User_data %>%
  group_by(Gender) %>%
  summarise(TotalPurchase = sum(Total_Purchase, na.rm = TRUE))  # na.rm = TRUE to remove NA values

# Now create the pie chart
ggplot(gender_purchase_totals, aes(x = "", y = TotalPurchase, fill = Gender)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") +  # This converts the bar chart to pie chart
  theme_void() +  # Remove axes and background
  scale_fill_manual(values = c("M" = "#efac37", "F" = "#e8615b"))

gender_purchase_summary <- gender_purchase_totals %>%
  mutate(Percentage = (TotalPurchase / sum(TotalPurchase)) * 100)
print(gender_purchase_summary)
```

```{r}
Age_purchase_totals <- cleaned_User_data %>%
  group_by(Age) %>%
  summarise(TotalPurchase = sum(Total_Purchase, na.rm = TRUE))  # na.rm = TRUE to remove NA values

# Now create the pie chart
ggplot(Age_purchase_totals, aes(x = "", y = TotalPurchase, fill = Age)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") +  # This converts the bar chart to pie chart
  theme_void() +  # Remove axes and background
  scale_fill_manual(values = c("0-17" = "#2f4a7f", "18-25" = "#efac37", "26-35" = "#162e4c", "36-45" = "#e8615b", "46-50" = "#476b9e", "51-55" = "#e5931c", "55+" = "#5982b2"))

Age_purchase_summary <- Age_purchase_totals %>%
  mutate(Percentage = (TotalPurchase / sum(TotalPurchase)) * 100)
print(Age_purchase_summary)
```

```{r}
City_Category_purchase_totals <- cleaned_User_data %>%
  group_by(City_Category) %>%
  summarise(TotalPurchase = sum(Total_Purchase, na.rm = TRUE))  # na.rm = TRUE to remove NA values

# Now create the pie chart
ggplot(City_Category_purchase_totals, aes(x = "", y = TotalPurchase, fill = City_Category)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") +  # This converts the bar chart to pie chart
  theme_void() +  # Remove axes and background
  scale_fill_manual(values = c("A" = "#efac37", "B" = "#e8615b", "C" = "#2f4a7f"))

City_Category_purchase_summary <- City_Category_purchase_totals %>%
  mutate(Percentage = (TotalPurchase / sum(TotalPurchase)) * 100)
print(City_Category_purchase_summary)
```

```{r}
Stay_In_Current_City_Years_purchase_totals <- cleaned_User_data %>%
  group_by(Stay_In_Current_City_Years) %>%
  summarise(TotalPurchase = sum(Total_Purchase, na.rm = TRUE))  # na.rm = TRUE to remove NA values

# Now create the pie chart
ggplot(Stay_In_Current_City_Years_purchase_totals, aes(x = "", y = TotalPurchase, fill = Stay_In_Current_City_Years)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") +  # This converts the bar chart to pie chart
  theme_void() +  # Remove axes and background
  scale_fill_manual(values = c("#2f4a7f", "#efac37", "#5982b2", "#e8615b", "#476b9e"))

Stay_In_Current_City_Years_purchase_summary <- Stay_In_Current_City_Years_purchase_totals %>%
  mutate(Percentage = (TotalPurchase / sum(TotalPurchase)) * 100)
print(Stay_In_Current_City_Years_purchase_summary)
```

```{r}
Marital_Status_purchase_totals <- cleaned_User_data %>%
  group_by(Marital_Status) %>%
  summarise(TotalPurchase = sum(Total_Purchase, na.rm = TRUE))  # na.rm = TRUE to remove NA values

# Now create the pie chart
ggplot(Marital_Status_purchase_totals, aes(x = "", y = TotalPurchase, fill = Marital_Status)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") +  # This converts the bar chart to pie chart
  theme_void() +  # Remove axes and background
  scale_fill_manual(values = c("0" = "#efac37", "1" = "#e8615b"))

Marital_Status_purchase_summary <- Marital_Status_purchase_totals %>%
  mutate(Percentage = (TotalPurchase / sum(TotalPurchase)) * 100)
print(Marital_Status_purchase_summary)
```

```{r}
percentages_Gender <- prop.table(table(BlackFriday_cleaned$Product_Category_1, BlackFriday_cleaned$Gender), margin = 1) 
percentages_Gender_df <- as.data.frame(percentages_Gender)
colnames(percentages_Gender_df) <- c("Product_Category_1", "Gender", "Percentage_Gender")
ggplot(percentages_Gender_df, aes(x = Product_Category_1, y = Percentage_Gender, fill = Gender)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(
    x = "Product_Category_1",
    y = "Gender"
  )+
  scale_fill_manual(values = c("F" = "#efac37", "M" = "#5982b2"))+
  theme_minimal() +
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  )
```

```{r}
percentages_Age <- prop.table(table(BlackFriday_cleaned$Product_Category_1, BlackFriday_cleaned$Age), margin = 1) 
percentages_Age_df <- as.data.frame(percentages_Age)
colnames(percentages_Age_df) <- c("Product_Category_1", "Age", "Percentage_Age")
ggplot(percentages_Age_df, aes(x = Product_Category_1, y = Percentage_Age, fill = Age)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(
    x = "Product_Category_1",
    y = "Age"
  )+
  scale_fill_manual(values = c("0-17" = "#2f4a7f", "18-25" = "#efac37", "26-35" = "#476b9e", "36-45" = "#e8615b", "46-50" = "#476b9e", "51-55" = "#e5931c", "55+" = "#d9ebff"))+
  theme_minimal() +
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  )
```

```{r}
percentages_City_Category <- prop.table(table(BlackFriday_cleaned$Product_Category_1, BlackFriday_cleaned$City_Category), margin = 1) 
percentages_City_Category_df <- as.data.frame(percentages_City_Category)
colnames(percentages_City_Category_df) <- c("Product_Category_1", "City_Category", "Percentage_City_Category")
ggplot(percentages_City_Category_df, aes(x = Product_Category_1, y = Percentage_City_Category, fill = City_Category)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(
    x = "Product_Category_1",
    y = "City_Category"
  )+
  scale_fill_manual(values = c("A" = "#efac37", "B" = "#e8615b", "C" = "#2f4a7f"))+
  theme_minimal() +
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  )
```

```{r}
percentages_Stay_In_Current_City_Years <- prop.table(table(BlackFriday_cleaned$Product_Category_1, BlackFriday_cleaned$Stay_In_Current_City_Years), margin = 1) 
percentages_Stay_In_Current_City_Years_df <- as.data.frame(percentages_Stay_In_Current_City_Years)
colnames(percentages_Stay_In_Current_City_Years_df) <- c("Product_Category_1", "Stay_In_Current_City_Years", "Percentage_Stay_In_Current_City_Years")
ggplot(percentages_Stay_In_Current_City_Years_df, aes(x = Product_Category_1, y = Percentage_Stay_In_Current_City_Years, fill = Stay_In_Current_City_Years)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(
    x = "Product_Category_1",
    y = "Stay_In_Current_City_Years"
  )+
  scale_fill_manual(values = c("0" = "#2f4a7f", "1" = "#efac37", "2" = "#5982b2", "3" = "#e8615b", "4" = "#476b9e"))+
  theme_minimal() +
  theme(
    plot.title = element_text(size = 25),        
    axis.title.x = element_text(size = 20),      
    axis.title.y = element_text(size = 20),      
    axis.text.x = element_text(size = 20),       
    axis.text.y = element_text(size = 20)        
  )
```


##  Sample Statistics
### Sample Statistics for User Data (Mean)

```{r}
summarize_statistics = function(dataset) {
  
  dataset = select_if(dataset, is.numeric)
  summary.table = data.frame(Attribute = names(dataset))
  
  summary.table = summary.table %>% 
    mutate('Mean' = colMeans(dataset, na.rm = TRUE),
           'SD' = apply(dataset, 2, function (x) sd(x, na.rm = TRUE)),
           'SE_Classic' = apply(dataset, 2, function (x) sd(x, na.rm = TRUE)/
                                  sqrt(length(x))),
           'SE_Bootstrap' = apply(dataset, 2, function (x) {
             set.seed(1)
             sample_means = rep(0, 1000)
             for (i in 1:1000) {
               sample_means[i] = mean(sample(x, length(x), replace = TRUE))
             }
             se_bootstrap = sd(sample_means)
             se_bootstrap
           }),
           '90%_CI_Classic' = apply(dataset, 2, function (x) {
             ci_lower = mean(x)-1.96*sd(x, na.rm = TRUE)/
                                  sqrt(length(x))
             ci_upper = mean(x)+1.96*sd(x, na.rm = TRUE)/
                                  sqrt(length(x))
             paste0("[", round(ci_lower, 2), ", ", round(ci_upper, 2), "]")
           }),
           '90%_CI_Bootstrap' = apply(dataset, 2, function (x) {
             set.seed(1)
             sample_means = rep(0, 1000)
             for (i in 1:1000) {
               sample_means[i] = mean(sample(x, length(x), replace = TRUE))
             }
             ci_lower = quantile(sample_means, 0.05)
             ci_upper = quantile(sample_means, 0.95)
             paste0("[", round(ci_lower, 2), ", ", round(ci_upper, 2), "]")
           })
    )
  summary.table
}
```


```{r}
summarize_statistics(cleaned_User_data)
```

### Sample Statistics for Product Data (Mean)
```{r}
summarize_statistics(cleaned_Product_data)
```


## Hypothesis Testing for Customer Information

### Total_Purchase

One-tailed hypothesis test to determine if there is a statistically significant difference between the total purchase of female and male.

Classical
```{r}
female <- cleaned_User_data$Total_Purchase[cleaned_User_data$Gender == 'F']
male <- cleaned_User_data$Total_Purchase[cleaned_User_data$Gender == 'M']

t.test(female, male, alternative = "greater")
```

Permutation Testing

```{r}
perm_fun <- function(x, nA)
{
  n = length(x)
  nB = n - nA
  idx_b <- sample(1:n, nB)
  idx_a <- setdiff(1:n, idx_b)
  perm_diffs <- mean(x[idx_b]) - mean(x[idx_a])
  return(list(idx_a = idx_a, idx_b = idx_b, perm_diffs = perm_diffs))
}
```

```{r}
set.seed(1)
obs_diff <- mean(female) - mean(male)

perm_diffs <- replicate(10000, {
  permuted_data <- sample(c(female, male))  
  new_female <- permuted_data[1:length(female)]  
  new_male <- permuted_data[(length(male) + 1):length(permuted_data)]
  mean(new_female) - mean(new_male)
})

p_value <- mean(perm_diffs >= obs_diff)
p_value
```

```{r}
ggplot(as_tibble(perm_diffs)) + geom_histogram(aes(x=value), fill = "#e8615b") +
  labs(title = "Check Differences")+
  geom_vline(xintercept = obs_diff, linetype = "dashed", size = 0.8)+
  geom_text(aes(x=obs_diff), label="\nObserved Difference", y=100, hjust="left")
```



One-tailed hypothesis test to determine if there is a statistically significant difference between the total purchase of unmarried customers and married customers.

Classical
```{r}
unmarried <- cleaned_User_data$Total_Purchase[cleaned_User_data$Marital_Status == 0]
married <- cleaned_User_data$Total_Purchase[cleaned_User_data$Marital_Status == 1]

t.test(unmarried, married, alternative = "greater")
```

Permutation Testing

```{r}
set.seed(1)
obs_diff <- mean(unmarried) - mean(married)

perm_diffs <- replicate(10000, {
  permuted_data <- sample(c(unmarried, married))  
  new_unmarried <- permuted_data[1:length(unmarried)]  
  new_married <- permuted_data[(length(married) + 1):length(permuted_data)]
  mean(new_unmarried) - mean(new_married)
})

p_value <- mean(perm_diffs >= obs_diff)
p_value
```

```{r}
ggplot(as_tibble(perm_diffs)) + geom_histogram(aes(x=value), fill = "#e8615b") +
  labs(title = "Check Differences")+
  geom_vline(xintercept = obs_diff, linetype = "dashed", size = 0.8)+
  geom_text(aes(x=obs_diff), label="\nObserved Difference", y=100, hjust="left")
```

One-way ANOVA to determine if there are statistically significant differences among the total purchase of different city categories

Classical

```{r}
summary(aovp(Total_Purchase ~ Age, data=cleaned_User_data))
```


Computational

```{r}
obs_var <- var(tapply(cleaned_User_data$Total_Purchase, cleaned_User_data$Age, mean))

# Permute and compute test statistics
set.seed(1)
vars <- replicate(10000, {
  # Shuffle the bills
  shuffled_total_purchase <- sample(cleaned_User_data$Total_Purchase)
  # Assign them back to the original data frame (maintaining sample sizes but ignoring labels)
  cleaned_User_data$Shuffled_Total_Purchase <- shuffled_total_purchase
  # Compute the variance in means for the permuted data
  var(tapply(cleaned_User_data$Shuffled_Total_Purchase, cleaned_User_data$Age, mean))
})

# Compute p-value
p_value <- mean(vars >= obs_var)
p_value
```


One-way ANOVA to determine if there are statistically significant differences among the total purchase of different occupation

Classical

```{r}
summary(aovp(Total_Purchase ~ Occupation, data=cleaned_User_data))
```


Computational

```{r}
obs_var <- var(tapply(cleaned_User_data$Total_Purchase, cleaned_User_data$Occupation, mean))

# Permute and compute test statistics
set.seed(1)
vars <- replicate(10000, {
  # Shuffle the bills
  shuffled_total_purchase <- sample(cleaned_User_data$Total_Purchase)
  # Assign them back to the original data frame (maintaining sample sizes but ignoring labels)
  cleaned_User_data$Shuffled_Total_Purchase <- shuffled_total_purchase
  # Compute the variance in means for the permuted data
  var(tapply(cleaned_User_data$Shuffled_Total_Purchase, cleaned_User_data$Occupation, mean))
})

# Compute p-value
p_value <- mean(vars >= obs_var)
p_value
```


One-way ANOVA to determine if there are statistically significant differences among the total purchase of different age groups

Classical

```{r}
summary(aovp(Total_Purchase ~ City_Category, data=cleaned_User_data))
```

Computational

```{r}
obs_var <- var(tapply(cleaned_User_data$Total_Purchase, cleaned_User_data$City_Category, mean))

# Permute and compute test statistics
set.seed(1)
vars <- replicate(10000, {
  # Shuffle the bills
  shuffled_total_purchase <- sample(cleaned_User_data$Total_Purchase)
  # Assign them back to the original data frame (maintaining sample sizes but ignoring labels)
  cleaned_User_data$Shuffled_Total_Purchase <- shuffled_total_purchase
  # Compute the variance in means for the permuted data
  var(tapply(cleaned_User_data$Shuffled_Total_Purchase, cleaned_User_data$City_Category, mean))
})

# Compute p-value
p_value <- mean(vars >= obs_var)
p_value
```


One-way ANOVA to determine if there are statistically significant differences among the total purchase of different groups with years stay in current city

Classical

```{r}
summary(aovp(Total_Purchase ~ Stay_In_Current_City_Years, data=cleaned_User_data))
```

Computational

```{r}
obs_var <- var(tapply(cleaned_User_data$Total_Purchase, cleaned_User_data$Stay_In_Current_City_Years, mean))

# Permute and compute test statistics
set.seed(1)
vars <- replicate(10000, {
  # Shuffle the bills
  shuffled_total_purchase <- sample(cleaned_User_data$Total_Purchase)
  # Assign them back to the original data frame (maintaining sample sizes but ignoring labels)
  cleaned_User_data$Shuffled_Total_Purchase <- shuffled_total_purchase
  # Compute the variance in means for the permuted data
  var(tapply(cleaned_User_data$Shuffled_Total_Purchase, cleaned_User_data$Stay_In_Current_City_Years, mean))
})

# Compute p-value
p_value <- mean(vars >= obs_var)
p_value
```

## Chi-Squared Test for Independence
A chi-squared test is used to determine if there is a significant association between two categorical variables. 

Gender & Age

```{r}
contingency_table <- table(cleaned_User_data$Gender, cleaned_User_data$Age)
chisq.test(contingency_table)
```


```{r}
contingency_df <- as.matrix(contingency_table)
legend_colors <- c("#e8615b", "#2f4a7f")
legend_labels <- c("Female", "Male")

stacked_bar_chart <- barplot(contingency_df, beside = TRUE, col = legend_colors,
                             main = "Female vs Male in Different Age Groups",
                             xlab = "Age Groups", ylab = "Frequency",
                             names.arg = colnames(contingency_df))

legend("topright", legend = legend_labels, fill = legend_colors)
```
Gender & Marital_Status

```{r}
contingency_table <- table(cleaned_User_data$Gender, cleaned_User_data$Marital_Status)
chisq.test(contingency_table)
```


```{r}
contingency_df <- as.matrix(contingency_table)
legend_colors <- c("#e8615b", "#2f4a7f")
legend_labels <- c("Female", "Male")

stacked_bar_chart <- barplot(contingency_df, beside = TRUE, col = legend_colors,
                             main = "Female vs Male in Different Marital_Status",
                             xlab = "Marital Status", ylab = "Frequency",
                             names.arg = colnames(contingency_df))

legend("topright", legend = legend_labels, fill = legend_colors)
```
Gender & City_Category

```{r}
contingency_table <- table(cleaned_User_data$Gender, cleaned_User_data$City_Category)
chisq.test(contingency_table)
```
```{r}
contingency_df <- as.matrix(contingency_table)
legend_colors <- c("#e8615b", "#2f4a7f")
legend_labels <- c("Female", "Male")

stacked_bar_chart <- barplot(contingency_df, beside = TRUE, col = legend_colors,
                             main = "Female vs Male in Different City Category",
                             xlab = "City Category", ylab = "Frequency",
                             names.arg = colnames(contingency_df))

legend("topleft", legend = legend_labels, fill = legend_colors)
```

Gender & Stay_In_Current_City_Years

```{r}
contingency_table <- table(cleaned_User_data$Gender, cleaned_User_data$Stay_In_Current_City_Years)
chisq.test(contingency_table)
```
```{r}
contingency_df <- as.matrix(contingency_table)
legend_colors <- c("#e8615b", "#2f4a7f")
legend_labels <- c("Female", "Male")

stacked_bar_chart <- barplot(contingency_df, beside = TRUE, col = legend_colors,
                             main = "Female vs Male in Different Year Spent in Current City",
                             xlab = "Year Spent in Current City", ylab = "Frequency",
                             names.arg = colnames(contingency_df))

legend("topright", legend = legend_labels, fill = legend_colors)
```
Marital_Status & Age
```{r}
contingency_table <- table(cleaned_User_data$Marital_Status, cleaned_User_data$Age)
chisq.test(contingency_table)
```
```{r}
contingency_df <- as.matrix(contingency_table)
legend_colors <- c("#e8615b", "#2f4a7f")
legend_labels <- c("0", "1")

stacked_bar_chart <- barplot(contingency_df, beside = TRUE, col = legend_colors,
                             main = "Different Marital Status in Different Age Group",
                             xlab = "Age", ylab = "Frequency",
                             names.arg = colnames(contingency_df))

legend("topright", legend = legend_labels, fill = legend_colors)
```
Marital_Status & City_Category

```{r}
contingency_table <- table(cleaned_User_data$Marital_Status, cleaned_User_data$City_Category)
chisq.test(contingency_table)
```
```{r}
contingency_df <- as.matrix(contingency_table)
legend_colors <- c("#e8615b", "#2f4a7f")
legend_labels <- c("0", "1")

stacked_bar_chart <- barplot(contingency_df, beside = TRUE, col = legend_colors,
                             main = "Different Marital Status in Different City Category",
                             xlab = "City Category", ylab = "Frequency",
                             names.arg = colnames(contingency_df))

legend("topright", legend = legend_labels, fill = legend_colors)
```

Marital_Status & Stay_In_Current_City_Years

```{r}
contingency_table <- table(cleaned_User_data$Marital_Status, cleaned_User_data$Stay_In_Current_City_Years)
chisq.test(contingency_table)
```
```{r}
contingency_df <- as.matrix(contingency_table)
legend_colors <- c("#e8615b", "#2f4a7f")
legend_labels <- c("0", "1")

stacked_bar_chart <- barplot(contingency_df, beside = TRUE, col = legend_colors,
                             main = "Different Marital Status in Different Year Spent in Current City",
                             xlab = "Year Spent in Current City", ylab = "Frequency",
                             names.arg = colnames(contingency_df))

legend("topright", legend = legend_labels, fill = legend_colors)
```

Age & City Category

```{r}
contingency_table <- table(cleaned_User_data$City_Category, cleaned_User_data$Age)
chisq.test(contingency_table)
```
```{r}
contingency_df <- as.matrix(contingency_table)
legend_colors <- c("#e8615b", "#2f4a7f", "#efac37")
legend_labels <- c("A", "B", "C")

stacked_bar_chart <- barplot(contingency_df, beside = TRUE, col = legend_colors,
                             main = "Different Age Group in Different City Category",
                             xlab = "Age Group", ylab = "Frequency",
                             names.arg = colnames(contingency_df))

legend("topright", legend = legend_labels, fill = legend_colors)
```
Age & Stay_In_Current_City_Years

```{r}
contingency_table <- table( cleaned_User_data$Stay_In_Current_City_Years, cleaned_User_data$Age)
chisq.test(contingency_table)
```
```{r}
contingency_df <- as.matrix(contingency_table)
legend_colors <- c("#e8615b", "#2f4a7f", "#efac37", "#B5ED12", "#129DED")
legend_labels <- c("0", "1", "2", "3", "4")

stacked_bar_chart <- barplot(contingency_df, beside = TRUE, col = legend_colors,
                             main = "Different Age Group in Different Year Spent in Current City",
                             xlab = "Age Group", ylab = "Frequency",
                             names.arg = colnames(contingency_df))

legend("topright", legend = legend_labels, fill = legend_colors)
```

City_Category & Stay_In_Current_City_Years

```{r}
contingency_table <- table(cleaned_User_data$City_Category, cleaned_User_data$Stay_In_Current_City_Years)
chisq.test(contingency_table)
```


```{r}
contingency_df <- as.matrix(contingency_table)
legend_colors <- c("#e8615b", "#2f4a7f", "#efac37")
legend_labels <- c("A", "B", "C")

stacked_bar_chart <- barplot(contingency_df, beside = TRUE, col = legend_colors,
                             main = "City Category A vs B vs C in Different Years of stay in Current city",
                             xlab = "Years of stay in Current city", ylab = "Frequency",
                             names.arg = colnames(contingency_df))

legend("topright", legend = legend_labels, fill = legend_colors)
```


One-way ANOVA to determine if there are statistically significant differences among the total purchase of different product category 1

Classical

```{r}
summary(aovp(Total_Purchase ~ Product_Category_1, data=cleaned_Product_data))
```
Computational

```{r}
obs_var <- var(tapply(cleaned_Product_data$Total_Purchase, cleaned_Product_data$Product_Category_1, mean))

# Permute and compute test statistics
set.seed(1)
vars <- replicate(10000, {
  # Shuffle the bills
  shuffled_Total_Purchase <- sample(cleaned_Product_data$Total_Purchase)
  # Assign them back to the original data frame (maintaining sample sizes but ignoring labels)
  cleaned_Product_data$Shuffled_Total_Purchase <- shuffled_Total_Purchase
  # Compute the variance in means for the permuted data
  var(tapply(cleaned_Product_data$Shuffled_Total_Purchase, cleaned_Product_data$Product_Category_1, mean))
})

# Compute p-value
p_value <- mean(vars >= obs_var)
p_value
```


One-way ANOVA to determine if there are statistically significant differences among the total purchase of different product category 2

Classical

```{r}
summary(aovp(Total_Purchase ~ Product_Category_2, data=cleaned_Product_data))
```

Computational

```{r}
obs_var <- var(tapply(cleaned_Product_data$Total_Purchase, cleaned_Product_data$Product_Category_2, mean))

# Permute and compute test statistics
set.seed(1)
vars <- replicate(10000, {
  # Shuffle the bills
  shuffled_Total_Purchase <- sample(cleaned_Product_data$Total_Purchase)
  # Assign them back to the original data frame (maintaining sample sizes but ignoring labels)
  cleaned_Product_data$Shuffled_Total_Purchase <- shuffled_Total_Purchase
  # Compute the variance in means for the permuted data
  var(tapply(cleaned_Product_data$Shuffled_Total_Purchase, cleaned_Product_data$Product_Category_2, mean))
})

# Compute p-value
p_value <- mean(vars >= obs_var)
p_value
```


One-way ANOVA to determine if there are statistically significant differences among the total purchase of different product category 3

Classical

```{r}
summary(aovp(Total_Purchase ~ Product_Category_3, data=cleaned_Product_data))
```


Computational

```{r}
obs_var <- var(tapply(cleaned_Product_data$Total_Purchase, cleaned_Product_data$Product_Category_3, mean))

# Permute and compute test statistics
set.seed(1)
vars <- replicate(10000, {
  # Shuffle the bills
  shuffled_Total_Purchase <- sample(cleaned_Product_data$Total_Purchase)
  # Assign them back to the original data frame (maintaining sample sizes but ignoring labels)
  cleaned_Product_data$Shuffled_Total_Purchase <- shuffled_Total_Purchase
  # Compute the variance in means for the permuted data
  var(tapply(cleaned_Product_data$Shuffled_Total_Purchase, cleaned_Product_data$Product_Category_3, mean))
})

# Compute p-value
p_value <- mean(vars >= obs_var)
p_value
```

Product_Category_1 & Product_Category_2

```{r}
contingency_table <- table(cleaned_Product_data$Product_Category_1, cleaned_Product_data$Product_Category_2)
chisq.test(contingency_table)
```

Product_Category_1 & Product_Category_3
```{r}
contingency_table <- table(cleaned_Product_data$Product_Category_1, cleaned_Product_data$Product_Category_3)
chisq.test(contingency_table)
```

Product_Category_2 & Product_Category_3
```{r}
contingency_table <- table(cleaned_Product_data$Product_Category_2, cleaned_Product_data$Product_Category_3)
chisq.test(contingency_table)
```



## Regression Tree Model

```{r}
library(rpart)
library(rpart.plot)
```

### User

```{r}
# Create the formula for the model
user_formula <- formula(Total_Purchase ~ Gender + Age + Occupation + City_Category +Stay_In_Current_City_Years + Marital_Status)

# Build the regression tree model
user_tree <- rpart(user_formula, data = cleaned_User_data,control = rpart.control())

rpart.plot(user_tree)

# Prune the tree using cross-validation
pruned_tree1 <- prune(user_tree, cp = 0.01)
options(scipen = 999)
rpart.plot(pruned_tree1, box.palette = "RdBu", branch.lty = 3, shadow.col = "gray", nn = TRUE,
           digits = 3,  roundint = TRUE)
```


```{r}
# For user information
summary(pruned_tree1)
```


```{r}
predictions <- predict(pruned_tree1, cleaned_User_data)

# Calculate R-squared
mean_response <- mean(cleaned_User_data$Total_Purchase)
ss_total <- sum((cleaned_User_data$Total_Purchase - mean_response)^2)
ss_residual <- sum((cleaned_User_data$Total_Purchase - predictions)^2)
rsquared <- 1 - (ss_residual / ss_total)
rsquared
```


### Product

```{r}
# Create the formula for the model
product_formula <- formula(Total_Purchase ~ Product_Category_1 + Product_Category_2 + Product_Category_3)

# Build the regression tree model
product_tree <- rpart(product_formula, data = cleaned_Product_data,control = rpart.control())

rpart.plot(product_tree)

# Prune the tree using cross-validation
pruned_tree2 <- prune(product_tree, cp = 0.01)
options(scipen = 999)
rpart.plot(pruned_tree2, box.palette = "RdBu", branch.lty = 3, shadow.col = "gray", nn = TRUE,
           digits = 3,  roundint = TRUE)
```


```{r}
summary(pruned_tree2)
```


```{r}
predictions <- predict(pruned_tree2, cleaned_Product_data)

# Calculate R-squared
mean_response <- mean(cleaned_Product_data$Total_Purchase)
ss_total <- sum((cleaned_Product_data$Total_Purchase - mean_response)^2)
ss_residual <- sum((cleaned_Product_data$Total_Purchase - predictions)^2)
rsquared <- 1 - (ss_residual / ss_total)
rsquared
```





































